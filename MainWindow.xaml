<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="winui_scripts_app.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:winui_scripts_app"
    xmlns:helpers="using:winui_scripts_app.Helpers"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="Script Runner">

    <Window.SystemBackdrop>
        <MicaBackdrop />
    </Window.SystemBackdrop>

    <!-- Top‑level NavigationView -->
    <NavigationView
        x:Name="MainNavView"
        PaneDisplayMode="LeftCompact"
        IsBackButtonVisible="Collapsed"
        IsSettingsVisible="False"
        SelectionChanged="MainNavView_SelectionChanged">

        <NavigationView.Resources>
            <helpers:ZeroToVisibilityConverter x:Key="ZeroToVisibilityConverter"/>
            <helpers:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        </NavigationView.Resources>

        <!-- Pane items -->
        <NavigationView.MenuItems>
            <NavigationViewItem Content="Refresh" Icon="Refresh" Tag="Refresh" />
            <NavigationViewItem Content="Open Scripts Folder" Icon="Folder" Tag="OpenFolder" />
        </NavigationView.MenuItems>

        <!-- Main content area -->
        <NavigationView.Content>
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Search Filter -->
                <Border
                    Grid.Row="0"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="16,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox
                            Grid.Column="0"
                            Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            PlaceholderText="Search scripts by name or folder..."
                            x:Name="SearchBox">
                            <TextBox.Resources>
                                <!-- Keep border/corners as you already set -->
                                <Style TargetType="TextBox">
                                    <Setter Property="BorderThickness" Value="1"/>
                                    <Setter Property="CornerRadius" Value="8"/>
                                </Style>

                                <!-- Remove the square hover/press background of the clear (delete) button -->
                                <SolidColorBrush x:Key="TextControlButtonBackground" Color="Transparent"/>
                                <SolidColorBrush x:Key="TextControlButtonBackgroundPointerOver" Color="Transparent"/>
                                <SolidColorBrush x:Key="TextControlButtonBackgroundPressed" Color="Transparent"/>
                                <SolidColorBrush x:Key="TextControlButtonBorderBrush" Color="Transparent"/>
                                <SolidColorBrush x:Key="TextControlButtonBorderBrushPointerOver" Color="Transparent"/>
                                <SolidColorBrush x:Key="TextControlButtonBorderBrushPressed" Color="Transparent"/>
                            </TextBox.Resources>
                        </TextBox>


                        <StackPanel 
                            Grid.Column="1" 
                            Orientation="Horizontal" 
                            Margin="8,0,0,0">
                            <TextBlock
                                Text="{Binding FilteredScriptCount}"
                                VerticalAlignment="Center"
                                Margin="12,0,0,0"
                                FontWeight="SemiBold"
                                Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                Visibility="{Binding IsSearchActive, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            <TextBlock
                                Text=" results"
                                VerticalAlignment="Center"
                                Margin="2,0,0,0"
                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                Visibility="{Binding IsSearchActive, Converter={StaticResource BoolToVisibilityConverter}}"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Script List with Folder Grouping -->
                <ScrollViewer Grid.Row="1" Padding="16" x:Name="ScriptListScrollViewer">
                    <ItemsControl ItemsSource="{Binding FilteredGroupedScripts}" x:Name="GroupedScriptsList">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="0,0,0,16">
                                    <!-- Folder Header -->
                                    <Border
                                        Background="{ThemeResource AccentFillColorSecondaryBrush}"
                                        CornerRadius="6"
                                        Padding="12,8"
                                        Margin="0,0,0,8">
                                        <StackPanel Orientation="Horizontal">
                                            <SymbolIcon
                                                Symbol="Folder"
                                                Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                                Margin="0,0,8,0" />
                                            <TextBlock
                                                Text="{Binding DisplayName}"
                                                FontWeight="SemiBold"
                                                FontSize="14"
                                                Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}" />
                                            <TextBlock
                                                Text="{Binding CountDisplay}"
                                                FontSize="14"
                                                Foreground="{ThemeResource AccentTextFillColorSecondaryBrush}"
                                                Margin="4,0,0,0" />
                                        </StackPanel>
                                    </Border>

                                    <!-- Scripts in this folder -->
                                    <ItemsControl ItemsSource="{Binding Scripts}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border
                                                    Margin="0,2"
                                                    Padding="16"
                                                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                                    CornerRadius="8"
                                                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                                    BorderThickness="1">
                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto" />
                                                            <RowDefinition Height="Auto" />
                                                        </Grid.RowDefinitions>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*" />
                                                            <ColumnDefinition Width="Auto" />
                                                        </Grid.ColumnDefinitions>

                                                        <!-- Item Details -->
                                                        <StackPanel
                                                            x:Name="DetailsPanel"
                                                            Grid.Row="0"
                                                            Grid.Column="0"
                                                            VerticalAlignment="Center"
                                                            Margin="0,0,16,0">
                                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                                                <TextBlock
                                                                    Text="{Binding Name}"
                                                                    FontWeight="SemiBold"
                                                                    FontSize="16"
                                                                    TextTrimming="CharacterEllipsis"
                                                                    ToolTipService.ToolTip="{Binding Name}" />
                                                                <!-- Folder badge if not root -->
                                                                <Border
                                                                    Background="{ThemeResource SystemFillColorSolidNeutralBackgroundBrush}"
                                                                    CornerRadius="10"
                                                                    Padding="6,2"
                                                                    Margin="8,0,0,0"
                                                                    Visibility="{Binding ShowFolderBadge}">
                                                                    <TextBlock
                                                                        Text="{Binding Folder}"
                                                                        FontSize="10"
                                                                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                                        TextTrimming="CharacterEllipsis" />
                                                                </Border>
                                                            </StackPanel>
                                                            <TextBlock
                                                                Text="{Binding LastExecutedDisplay}"
                                                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                                FontSize="12"
                                                                Margin="0,0,0,2"
                                                                TextTrimming="CharacterEllipsis"
                                                                ToolTipService.ToolTip="{Binding LastExecutedDisplay}" />
                                                            <TextBlock
                                                                Text="{Binding FileSizeDisplay}"
                                                                Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                                                                FontSize="11"
                                                                TextTrimming="CharacterEllipsis" />
                                                        </StackPanel>

                                                        <!-- Action Buttons -->
                                                        <StackPanel
                                                            x:Name="ButtonsPanel"
                                                            Grid.Row="0"
                                                            Grid.Column="1"
                                                            Orientation="Horizontal"
                                                            VerticalAlignment="Center"
                                                            HorizontalAlignment="Right">
                                                            <Button
                                                                Click="RunButton_Click"
                                                                Tag="{Binding}"
                                                                IsEnabled="{Binding IsNotExecuting}"
                                                                Style="{StaticResource AccentButtonStyle}"
                                                                Margin="0,0,8,0"
                                                                ToolTipService.ToolTip="Run Script"
                                                                MinWidth="100">
                                                                <StackPanel Orientation="Horizontal">
                                                                    <SymbolIcon Symbol="Play" Margin="0,0,4,0"/>
                                                                    <TextBlock Text="Run"/>
                                                                </StackPanel>
                                                            </Button>
                                                            <Button
                                                                Click="DeleteButton_Click"
                                                                Tag="{Binding}"
                                                                Margin="0,0,8,0"
                                                                ToolTipService.ToolTip="Delete Script"
                                                                MinWidth="100">
                                                                <StackPanel Orientation="Horizontal">
                                                                    <SymbolIcon Symbol="Delete" Margin="10,0,4,0"/>
                                                                    <TextBlock Text="Delete"/>
                                                                </StackPanel>
                                                            </Button>
                                                            <ProgressRing
                                                                IsActive="{Binding IsExecuting}"
                                                                Width="24"
                                                                Height="24"
                                                                ToolTipService.ToolTip="Script is executing..." />
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Empty State -->
                <StackPanel
                    Grid.Row="1"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Visibility="{Binding Scripts.Count, Converter={StaticResource ZeroToVisibilityConverter}}">
                    <SymbolIcon
                        Symbol="Document"
                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                        Margin="0,0,0,16" />
                    <TextBlock
                        Text="No Scripts Found"
                        FontSize="20"
                        FontWeight="SemiBold"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,8" />
                    <TextBlock
                        Text="Place your scripts in the Documents\Scripts folder"
                        FontSize="14"
                        Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,8" />
                    <TextBlock
                        Text="Organize them in subfolders for better management"
                        FontSize="12"
                        Foreground="{ThemeResource TextFillColorTertiaryBrush}"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,16" />
                    <Button
                        Command="{Binding OpenFolderCommand}"
                        Style="{StaticResource AccentButtonStyle}">
                        <StackPanel Orientation="Horizontal">
                            <SymbolIcon Symbol="Folder" Margin="0,0,8,0"/>
                            <TextBlock Text="Open Scripts Folder"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Status Bar -->
                <Border
                    Grid.Row="2"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="0,1,0,0">
                    <Grid Padding="16,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock
                            Grid.Column="0"
                            Text="{Binding StatusMessage}"
                            VerticalAlignment="Center"
                            TextTrimming="CharacterEllipsis"/>
                        <StackPanel
                            Grid.Column="1"
                            Orientation="Horizontal"
                            VerticalAlignment="Center">
                            <TextBlock>
                                <Run Text="Scripts: "/>
                                <Run Text="{Binding ScriptCount}"/>
                            </TextBlock>
                            <TextBlock
                                Text=" • "
                                Margin="8,0"
                                Foreground="{ThemeResource TextFillColorTertiaryBrush}"/>
                            <TextBlock>
                                <Run Text="Folders: "/>
                                <Run Text="{Binding FolderCount}"/>
                            </TextBlock>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>
        </NavigationView.Content>
    </NavigationView>
</Window>
